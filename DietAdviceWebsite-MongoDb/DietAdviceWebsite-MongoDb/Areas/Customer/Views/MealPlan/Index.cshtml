@using System.Text.Json
@model DietAdviceWebsite_MongoDb.Areas.Customer.ViewModels.MealPlanViewModel
@{
    ViewData["Title"] = "Kế hoạch ăn uống thông minh";

    var allMeals = Model?.MealsEaten ?? new List<DietAdviceWebsite_MongoDb.Areas.Customer.ViewModels.MealEatenViewModel>();

    var mealConfigs = new[]
    {
        new { Id = "breakfast", Title = "Bữa Sáng", Icon = "☕", Time = "06:00 - 08:00", Keyword = "sáng" },
        new { Id = "lunch", Title = "Bữa Trưa", Icon = "🍱", Time = "11:00 - 13:00", Keyword = "trưa" },
        new { Id = "dinner", Title = "Bữa Tối", Icon = "🍲", Time = "18:00 - 20:00", Keyword = "tối" }
    };

    // 3. Lọc riêng Snack (những món không thuộc 3 bữa trên)
    // Logic: Lấy tất cả món, loại bỏ những món có TimeSlot chứa từ khóa sáng/trưa/tối
    var mainMealKeywords = mealConfigs.Select(c => c.Keyword).ToList();
    var snackMeals = allMeals.Where(m =>
    m.TimeSlot == null ||
    !mainMealKeywords.Any(k => m.TimeSlot.ToLower().Contains(k))
    ).ToList();
}

<div class="container main-content">
    <div class="header-section">
        <h1>Thực đơn hôm nay</h1>
        <p class="page-subtitle" id="currentDateDisplay">@DateTime.Now.ToString("dddd, dd/MM/yyyy", new
                        System.Globalization.CultureInfo("vi-VN"))</p>

        <div class="calorie-budget-card">
            <div class="budget-item target">
                <span class="label">Mục tiêu</span>
                <span class="value" id="goalCalories">@Model.DailyCalorieTarget</span>
                <span class="unit">kcal</span>
            </div>
            <div class="budget-divider">-</div>
            <div class="budget-item consumed">
                <span class="value" id="consumedCalories">@(allMeals.Sum(m => m.CaloriesConsumed))</span>
                <span class="unit">kcal</span>
            </div>
            <div class="budget-divider">=</div>
            <div class="budget-item remaining">
                <span class="label">Còn lại</span>
                <span class="value" id="remainingCalories">@(@Model.DailyCalorieTarget - allMeals.Sum(m =>
                                        m.CaloriesConsumed))</span>
                <span class="unit">kcal</span>
            </div>
            <div class="status-badge" id="dayStatus">Đang tính...</div>
        </div>
    </div>

    <div class="meal-plan-container">
        @foreach (var config in mealConfigs)
        {
            // Lọc món ăn cho bữa hiện tại trong vòng lặp
            var currentMeals = allMeals.Where(m => m.TimeSlot != null &&
            m.TimeSlot.ToLower().Contains(config.Keyword)).ToList();

            <div class="meal-section" id="section-@config.Id">
                <div class="section-header">
                    <h3>@config.Icon @config.Title <span class="time-range">(@config.Time)</span></h3>
                </div>

                @if (config.Id == "dinner")
                {
                    <div id="dinner-alert" class="dinner-alert" style="display: none;">
                        ⚠️ Bạn chỉ còn <b id="dinner-remaining">0</b> kcal. Hãy chọn món nhẹ nhàng!
                    </div>
                }

                <div class="meal-grid" id="grid-@config.Id">
                    @if (currentMeals.Any())
                    {
                        foreach (var item in currentMeals)
                        {
                            <div class="meal-card selected">
                                <span class="meal-name">@item.Name (@(item.Quantity == 1 ? "" : item.Quantity + " ")@item.Unit)</span>
                                <span class="meal-info">@item.CaloriesConsumed kcal</span>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="empty-text">Chưa có món ăn nào.</p>
                    }
                </div>

                <div class="section-footer">
                    <button class="btn-add-side" onclick="openChangeModal('@config.Id', '@config.Title')">+ Thay món ăn</button>
                </div>
            </div>
        }
    </div>

    <div class="snacks-section">
        <div class="section-header">
            <h3>🍿 Bữa Phụ / Ăn Vặt (Luôn mở)</h3>
            <button class="btn-add-snack" onclick="openAddModal('Bửa Phụ')">+ Khai báo món ăn vặt</button>
        </div>
        <div class="snack-list" id="snackList">
            @if (snackMeals.Any())
            {
                foreach (var item in snackMeals)
                {
                    <div class="snack-chip">
                        @item.Name (@(item.Quantity == 1 ? "" : item.Quantity + " ")@item.Unit) (@item.CaloriesConsumed kcal)
                        <span class="remove-snack" onclick="removeItem('Bửa Phụ', '@item.MealId')">&times;</span>
                    </div>
                }
            }
            else
            {
                <p class="empty-text" style="color:#aaa; font-style:italic;">Chưa có bữa phụ nào.</p>
            }
        </div>
    </div>
</div>

<div id="addFoodModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Thêm món ăn</h2>
        <div class="modal-search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="modalSearchInput" placeholder="Tìm món phở, cơm, bánh..." autocomplete="off">
            <div id="modalSuggestions" class="suggestions-dropdown"></div>
        </div>
        <div id="selectedItemDetails" style="display: none;">
            <div class="selected-food-info">
                <h4 id="selName" style="margin: 0 0 5px 0;">Tên món</h4>
                <h4 id="seftId"></h4>
                <div class="sel-nutrition" style="color: #666; font-size: 0.9rem;">
                    <span id="selCal" style="font-weight: bold; color: #27ae60;">0</span> kcal / 100g &bull;
                    <span id="selPro">0</span>g Pro / 100g
                </div>
            </div>
            <div class="quantity-control" style="margin-top: 15px;">
                <label for="selQty">Số lượng &amp; Đơn vị:</label>
                <div class="qty-inputs">
                    <input type="number" id="selQty" value="1" min="0" step="1" style="flex-grow: 1;">
                    <select id="selUnit" name="unit"
                        style="flex-grow: 2; margin-left: 8px; border: 1px solid #ddd; border-radius: 4px; padding: 6px 10px;">
                        <!-- Options will be populated by JavaScript based on the selected food -->
                    </select>
                </div>
                <p class="total-preview" style="margin-top: 10px; font-weight: bold;">
                    Tổng cộng: <span id="totalPreviewCal" style="color: #e67e22; font-size: 1.2rem;">0</span> kcal
                </p>
            </div>
            <button class="btn-confirm-add" onclick="confirmAddFood()">Thêm vào thực đơn</button>
        </div>
    </div>
</div>

<div id="changeMealModal" class="modal">
    <div class="modal-content large-modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">Thay đổi thực đơn</h2>

        <!-- 4.1 Filter & Add -->
        <div class="modal-controls" style="display: flex; flex-direction: column; gap: 10px;">

            <div style="display: flex; gap: 10px;">
                <div class="control-group" style="flex: 1;">
                    <label>Lọc theo Calo (<=):< /label>
                            <input type="number" id="targetCalInput" placeholder="VD: 500"
                                oninput="filterMealOptions()">
                </div>
                <div class="control-group" style="flex: 2;">
                    <label>Chọn món ăn:</label>
                    <select id="mealSelectBox" onchange="onComboSelectionChange()" class="form-control">
                        <option value="">-- Chọn món ăn --</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div class="control-group" style="flex: 1;">
                    <label>Số lượng:</label>
                    <input type="number" id="comboQty" value="1" min="0" step="1" class="form-control">
                </div>

                <div class="control-group" style="flex: 1;">
                    <label>Đơn vị:</label>
                    <select id="comboUnit" class="form-control">
                    </select>
                </div>

                <button class="btn-add-item" onclick="addFromControlPanel()"
                    style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; height: 38px;">
                    <i class="fa fa-plus"></i> Thêm
                </button>
            </div>
        </div>

        <!-- 4.2 Current Items List (Horizontal Box) -->
        <div class="current-items-container">
            <label>Các món trong bữa này:</label>
            <div id="modalCurrentList" class="horizontal-list">
                <!-- Item render mẫu bởi JS -->
            </div>
            <p id="modalTotalCal" class="modal-summary">Tổng: 0 kcal</p>
        </div>

        <button class="btn-confirm-save" onclick="saveMealChanges()">Lưu thay đổi</button>
    </div>
</div>

<link rel="stylesheet" href="~/css/meal-plan.css">

@section Scripts {
    <script>
        @{
                var jsonOptions = new JsonSerializerOptions
                {
                            PropertyNamingPolicy = JsonNamingPolicy.CamelCase
                };

                    object dataToSerialize = Model;
                if (dataToSerialize == null)
                {
                            dataToSerialize = new { mealsEaten = new object[] { } };
                }
            }

            // Serialize dữ liệu với cấu hình đã tạo
            const initialMealPlan = @Html.Raw(JsonSerializer.Serialize(dataToSerialize, jsonOptions));
    </script>

    <script src="~/js/meal-plan.js" asp-append-version="true"></script>
}